<!doctype html>
<html>
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" />
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

  <style>
    body {
      margin: 0;
      background: #040b35;
    }

    #map {
      width: 100%;
      height: 100vh;
    }

    #selector {
      font-weight: bold;
      z-index: 1000;
      position: absolute;
      padding: 0.5em;
      margin: 1em;
      background-color: white;
      border-radius: 10px;
      box-shadow: 5px 5px 5px gray;
    }
    @media (prefers-color-scheme: dark) {
      .maplibregl-popup-content {
        background: #32323f;
      }
    }
  </style>
  </head>
  <body>
  <div id="map"></div>
  <script type="module">
  import maplibregl from "https://cdn.jsdelivr.net/npm/maplibre-gl@5.1.0/+esm"
  import { Protocol } from "https://cdn.jsdelivr.net/npm/pmtiles@4.2.1/+esm"

  let protocol = new Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  const map = new maplibregl.Map({
    style: "https://tuiles.enliberte.fr/styles/bright.json",
    container: "map",
    center: [7.75, 48.58],
//    center: [7.7186403, 48.5830415],
    zoom: 13,
    attributionControl: { customAttribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' },
  })


  map.doubleClickZoom.disable();

  map.on('load', () => {
      map.addSource('panneaux', {
          'type': 'geojson',
          'data': {
              'type': 'FeatureCollection',
              'features': []
          }
      });

      map.addLayer({
          id: 'panneaux',
          source: 'panneaux',
          'type': 'circle',
          'paint': {
              'circle-radius': 10,
              'circle-color':  [
                "interpolate-hcl",
                ["linear"],
                ["get", "delai"],
                0,
                ["get", "color"],
                240,
                "grey"
              ],
              'circle-stroke-width': 2,
              'circle-stroke-color': { "type": "identity", "property": "strokeColor" },
              'circle-blur': { "type": "identity", "property": "blur" },
          },
      });

      // When a click event occurs on a feature in the places layer, open a popup at the
      // location of the feature, with description HTML from its properties.
      map.on('click', 'panneaux', (e) => {
          const coordinates = e.features[0].geometry.coordinates.slice();
          const description = e.features[0].properties.description;

          // Ensure that if the map is zoomed out such that multiple
          // copies of the feature are visible, the popup appears
          // over the copy being pointed to.
          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
              coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
          }

          new maplibregl.Popup()
              .setLngLat(coordinates)
              .setHTML(description)
              .addTo(map);
      });

      // Change the cursor to a pointer when the mouse is over the panneaux layer.
      map.on('mouseenter', 'panneaux', () => {
          map.getCanvas().style.cursor = 'pointer';
      });

      // Change it back to a pointer when it leaves.
      map.on('mouseleave', 'panneaux', () => {
          map.getCanvas().style.cursor = '';
      });

      map.on('dblclick', () => {
        alert("ok")
      })

    grist.ready({
      allowSelectBy: true,
      requiredAccess: 'read table',
    });

    // Adopté => oui/non => contour
    // À faire Couleur
    // Vieux => Flou
    grist.onRecords(records => {
      const payload =  {
        type: 'FeatureCollection',
        features: records.map(record => {
          return {
            type: 'Feature',
            properties: {
                description: record.Description,
                icon: 'marker',
                strokeColor: record.Adoptions.length ? 'green' : 'black',
                color: record.Couleur,
                blur: record.Delai/240/2,
                delai: record.Delai,
            },
            geometry: {
                type: 'Point',
                coordinates: [record.Longitude, record.Latitude]
            }
          }
        })
      }

      map.getSource('panneaux').setData(payload);
    })

  })


  map.addControl(
      new maplibregl.GeolocateControl({
          positionOptions: {
              enableHighAccuracy: true
          },
          trackUserLocation: true
      })
  );
  </script>
  </body>
</html>
